// <auto-generated/>
// Generated Query protocol handler for Sns

using System.Net;
using System.Text;
using Amazon.SimpleNotificationService;
using Amazon.SimpleNotificationService.Model;
using Amazon.Runtime;

namespace LocalSqsSnsMessaging.Http.Handlers;

/// <summary>
/// Handles Sns operations using Query protocol.
/// </summary>
internal static partial class SnsOperationHandler
{
    public static async Task<HttpResponseMessage> HandleAsync(
        HttpRequestMessage request,
        string operationName,
        InMemoryAwsBus bus,
        CancellationToken cancellationToken)
    {
        ArgumentNullException.ThrowIfNull(request);
        ArgumentNullException.ThrowIfNull(operationName);
        ArgumentNullException.ThrowIfNull(bus);

        using IAmazonSimpleNotificationService client = bus.CreateRawSnsClient();

        return operationName switch
        {
            "AddPermission" => await HandleAddPermissionAsync(request, client, cancellationToken),
            "CheckIfPhoneNumberIsOptedOut" => await HandleCheckIfPhoneNumberIsOptedOutAsync(request, client, cancellationToken),
            "ConfirmSubscription" => await HandleConfirmSubscriptionAsync(request, client, cancellationToken),
            "CreatePlatformApplication" => await HandleCreatePlatformApplicationAsync(request, client, cancellationToken),
            "CreatePlatformEndpoint" => await HandleCreatePlatformEndpointAsync(request, client, cancellationToken),
            "CreateSMSSandboxPhoneNumber" => await HandleCreateSMSSandboxPhoneNumberAsync(request, client, cancellationToken),
            "CreateTopic" => await HandleCreateTopicAsync(request, client, cancellationToken),
            "DeleteEndpoint" => await HandleDeleteEndpointAsync(request, client, cancellationToken),
            "DeletePlatformApplication" => await HandleDeletePlatformApplicationAsync(request, client, cancellationToken),
            "DeleteSMSSandboxPhoneNumber" => await HandleDeleteSMSSandboxPhoneNumberAsync(request, client, cancellationToken),
            "DeleteTopic" => await HandleDeleteTopicAsync(request, client, cancellationToken),
            "GetDataProtectionPolicy" => await HandleGetDataProtectionPolicyAsync(request, client, cancellationToken),
            "GetEndpointAttributes" => await HandleGetEndpointAttributesAsync(request, client, cancellationToken),
            "GetPlatformApplicationAttributes" => await HandleGetPlatformApplicationAttributesAsync(request, client, cancellationToken),
            "GetSMSAttributes" => await HandleGetSMSAttributesAsync(request, client, cancellationToken),
            "GetSMSSandboxAccountStatus" => await HandleGetSMSSandboxAccountStatusAsync(request, client, cancellationToken),
            "GetSubscriptionAttributes" => await HandleGetSubscriptionAttributesAsync(request, client, cancellationToken),
            "GetTopicAttributes" => await HandleGetTopicAttributesAsync(request, client, cancellationToken),
            "ListEndpointsByPlatformApplication" => await HandleListEndpointsByPlatformApplicationAsync(request, client, cancellationToken),
            "ListOriginationNumbers" => await HandleListOriginationNumbersAsync(request, client, cancellationToken),
            "ListPhoneNumbersOptedOut" => await HandleListPhoneNumbersOptedOutAsync(request, client, cancellationToken),
            "ListPlatformApplications" => await HandleListPlatformApplicationsAsync(request, client, cancellationToken),
            "ListSMSSandboxPhoneNumbers" => await HandleListSMSSandboxPhoneNumbersAsync(request, client, cancellationToken),
            "ListSubscriptions" => await HandleListSubscriptionsAsync(request, client, cancellationToken),
            "ListSubscriptionsByTopic" => await HandleListSubscriptionsByTopicAsync(request, client, cancellationToken),
            "ListTagsForResource" => await HandleListTagsForResourceAsync(request, client, cancellationToken),
            "ListTopics" => await HandleListTopicsAsync(request, client, cancellationToken),
            "OptInPhoneNumber" => await HandleOptInPhoneNumberAsync(request, client, cancellationToken),
            "Publish" => await HandlePublishAsync(request, client, cancellationToken),
            "PublishBatch" => await HandlePublishBatchAsync(request, client, cancellationToken),
            "PutDataProtectionPolicy" => await HandlePutDataProtectionPolicyAsync(request, client, cancellationToken),
            "RemovePermission" => await HandleRemovePermissionAsync(request, client, cancellationToken),
            "SetEndpointAttributes" => await HandleSetEndpointAttributesAsync(request, client, cancellationToken),
            "SetPlatformApplicationAttributes" => await HandleSetPlatformApplicationAttributesAsync(request, client, cancellationToken),
            "SetSMSAttributes" => await HandleSetSMSAttributesAsync(request, client, cancellationToken),
            "SetSubscriptionAttributes" => await HandleSetSubscriptionAttributesAsync(request, client, cancellationToken),
            "SetTopicAttributes" => await HandleSetTopicAttributesAsync(request, client, cancellationToken),
            "Subscribe" => await HandleSubscribeAsync(request, client, cancellationToken),
            "TagResource" => await HandleTagResourceAsync(request, client, cancellationToken),
            "Unsubscribe" => await HandleUnsubscribeAsync(request, client, cancellationToken),
            "UntagResource" => await HandleUntagResourceAsync(request, client, cancellationToken),
            "VerifySMSSandboxPhoneNumber" => await HandleVerifySMSSandboxPhoneNumberAsync(request, client, cancellationToken),
            _ => throw new NotSupportedException($"Sns operation '{operationName}' is not supported.")
        };
    }

    private static async Task<HttpResponseMessage> HandleAddPermissionAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeAddPermissionRequest(requestBody);
            var result = await client.AddPermissionAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeAddPermissionResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleCheckIfPhoneNumberIsOptedOutAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeCheckIfPhoneNumberIsOptedOutRequest(requestBody);
            var result = await client.CheckIfPhoneNumberIsOptedOutAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeCheckIfPhoneNumberIsOptedOutResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleConfirmSubscriptionAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeConfirmSubscriptionRequest(requestBody);
            var result = await client.ConfirmSubscriptionAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeConfirmSubscriptionResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleCreatePlatformApplicationAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeCreatePlatformApplicationRequest(requestBody);
            var result = await client.CreatePlatformApplicationAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeCreatePlatformApplicationResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleCreatePlatformEndpointAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeCreatePlatformEndpointRequest(requestBody);
            var result = await client.CreatePlatformEndpointAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeCreatePlatformEndpointResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleCreateSMSSandboxPhoneNumberAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeCreateSMSSandboxPhoneNumberRequest(requestBody);
            var result = await client.CreateSMSSandboxPhoneNumberAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeCreateSMSSandboxPhoneNumberResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleCreateTopicAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeCreateTopicRequest(requestBody);
            var result = await client.CreateTopicAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeCreateTopicResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleDeleteEndpointAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeDeleteEndpointRequest(requestBody);
            var result = await client.DeleteEndpointAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeDeleteEndpointResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleDeletePlatformApplicationAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeDeletePlatformApplicationRequest(requestBody);
            var result = await client.DeletePlatformApplicationAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeDeletePlatformApplicationResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleDeleteSMSSandboxPhoneNumberAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeDeleteSMSSandboxPhoneNumberRequest(requestBody);
            var result = await client.DeleteSMSSandboxPhoneNumberAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeDeleteSMSSandboxPhoneNumberResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleDeleteTopicAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeDeleteTopicRequest(requestBody);
            var result = await client.DeleteTopicAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeDeleteTopicResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleGetDataProtectionPolicyAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeGetDataProtectionPolicyRequest(requestBody);
            var result = await client.GetDataProtectionPolicyAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeGetDataProtectionPolicyResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleGetEndpointAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeGetEndpointAttributesRequest(requestBody);
            var result = await client.GetEndpointAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeGetEndpointAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleGetPlatformApplicationAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeGetPlatformApplicationAttributesRequest(requestBody);
            var result = await client.GetPlatformApplicationAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeGetPlatformApplicationAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleGetSMSAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeGetSMSAttributesRequest(requestBody);
            var result = await client.GetSMSAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeGetSMSAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleGetSMSSandboxAccountStatusAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeGetSMSSandboxAccountStatusRequest(requestBody);
            var result = await client.GetSMSSandboxAccountStatusAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeGetSMSSandboxAccountStatusResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleGetSubscriptionAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeGetSubscriptionAttributesRequest(requestBody);
            var result = await client.GetSubscriptionAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeGetSubscriptionAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleGetTopicAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeGetTopicAttributesRequest(requestBody);
            var result = await client.GetTopicAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeGetTopicAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListEndpointsByPlatformApplicationAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeListEndpointsByPlatformApplicationRequest(requestBody);
            var result = await client.ListEndpointsByPlatformApplicationAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeListEndpointsByPlatformApplicationResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListOriginationNumbersAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeListOriginationNumbersRequest(requestBody);
            var result = await client.ListOriginationNumbersAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeListOriginationNumbersResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListPhoneNumbersOptedOutAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeListPhoneNumbersOptedOutRequest(requestBody);
            var result = await client.ListPhoneNumbersOptedOutAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeListPhoneNumbersOptedOutResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListPlatformApplicationsAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeListPlatformApplicationsRequest(requestBody);
            var result = await client.ListPlatformApplicationsAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeListPlatformApplicationsResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListSMSSandboxPhoneNumbersAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeListSMSSandboxPhoneNumbersRequest(requestBody);
            var result = await client.ListSMSSandboxPhoneNumbersAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeListSMSSandboxPhoneNumbersResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListSubscriptionsAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeListSubscriptionsRequest(requestBody);
            var result = await client.ListSubscriptionsAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeListSubscriptionsResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListSubscriptionsByTopicAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeListSubscriptionsByTopicRequest(requestBody);
            var result = await client.ListSubscriptionsByTopicAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeListSubscriptionsByTopicResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListTagsForResourceAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeListTagsForResourceRequest(requestBody);
            var result = await client.ListTagsForResourceAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeListTagsForResourceResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListTopicsAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeListTopicsRequest(requestBody);
            var result = await client.ListTopicsAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeListTopicsResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleOptInPhoneNumberAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeOptInPhoneNumberRequest(requestBody);
            var result = await client.OptInPhoneNumberAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeOptInPhoneNumberResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandlePublishAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializePublishRequest(requestBody);
            var result = await client.PublishAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializePublishResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandlePublishBatchAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializePublishBatchRequest(requestBody);
            var result = await client.PublishBatchAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializePublishBatchResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandlePutDataProtectionPolicyAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializePutDataProtectionPolicyRequest(requestBody);
            var result = await client.PutDataProtectionPolicyAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializePutDataProtectionPolicyResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleRemovePermissionAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeRemovePermissionRequest(requestBody);
            var result = await client.RemovePermissionAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeRemovePermissionResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleSetEndpointAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeSetEndpointAttributesRequest(requestBody);
            var result = await client.SetEndpointAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeSetEndpointAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleSetPlatformApplicationAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeSetPlatformApplicationAttributesRequest(requestBody);
            var result = await client.SetPlatformApplicationAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeSetPlatformApplicationAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleSetSMSAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeSetSMSAttributesRequest(requestBody);
            var result = await client.SetSMSAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeSetSMSAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleSetSubscriptionAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeSetSubscriptionAttributesRequest(requestBody);
            var result = await client.SetSubscriptionAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeSetSubscriptionAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleSetTopicAttributesAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeSetTopicAttributesRequest(requestBody);
            var result = await client.SetTopicAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeSetTopicAttributesResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleSubscribeAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeSubscribeRequest(requestBody);
            var result = await client.SubscribeAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeSubscribeResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleTagResourceAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeTagResourceRequest(requestBody);
            var result = await client.TagResourceAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeTagResourceResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleUnsubscribeAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeUnsubscribeRequest(requestBody);
            var result = await client.UnsubscribeAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeUnsubscribeResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleUntagResourceAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeUntagResourceRequest(requestBody);
            var result = await client.UntagResourceAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeUntagResourceResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleVerifySMSSandboxPhoneNumberAsync(
        HttpRequestMessage request,
        IAmazonSimpleNotificationService client,
        CancellationToken cancellationToken)
    {
        try
        {
            var requestBody = request.Content != null ? await request.Content.ReadAsStringAsync(cancellationToken).ConfigureAwait(false) : string.Empty;
            var requestObject = SnsQuerySerializers.DeserializeVerifySMSSandboxPhoneNumberRequest(requestBody);
            var result = await client.VerifySMSSandboxPhoneNumberAsync(requestObject, cancellationToken).ConfigureAwait(false);

            var responseStream = new MemoryStream();
            SnsQuerySerializers.SerializeVerifySMSSandboxPhoneNumberResponse(result, responseStream);
            var responseXml = Encoding.UTF8.GetString(responseStream.ToArray());

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new StringContent(responseXml, Encoding.UTF8, "text/xml")
            };
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AmazonServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static HttpResponseMessage CreateErrorResponse(Exception exception)
    {
        // Extract error code from AmazonServiceException if available
        string errorCode;
        string errorMessage;
        HttpStatusCode statusCode;

        if (exception is AmazonServiceException awsException)
        {
            errorCode = awsException.ErrorCode ?? exception.GetType().Name.Replace("Exception", "");
            errorMessage = awsException.Message;
            statusCode = awsException.StatusCode;
        }
        else
        {
            errorCode = exception.GetType().Name.Replace("Exception", "");
            errorMessage = exception.Message;
            statusCode = HttpStatusCode.InternalServerError;
        }

        var errorXml = $"""
        <?xml version="1.0" encoding="UTF-8"?>
        <ErrorResponse xmlns="http://sns.amazonaws.com/doc/2010-03-31/">
            <Error>
                <Type>Sender</Type>
                <Code>{errorCode}</Code>
                <Message>{System.Security.SecurityElement.Escape(errorMessage)}</Message>
            </Error>
            <RequestId>{Guid.NewGuid()}</RequestId>
        </ErrorResponse>
        """;

        return new HttpResponseMessage(statusCode)
        {
            Content = new StringContent(errorXml, Encoding.UTF8, "text/xml")
        };
    }
}
