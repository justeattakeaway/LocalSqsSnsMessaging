<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalSqsSnsMessaging</title>
    <link rel="stylesheet" href="/_ui/dashboard.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer src="/_ui/dashboard.js"></script>
</head>
<body x-data="dashboard()" x-init="init()">

    <!-- Top bar -->
    <div class="topbar">
        <div class="topbar-left">
            <div class="topbar-title">
                LocalSqsSnsMessaging <span>Dashboard</span>
            </div>
            <div class="topbar-nav">
                <button class="nav-btn" :class="{ active: view === 'resources' }" @click="view = 'resources'">Resources</button>
                <button class="nav-btn" :class="{ active: view === 'activity' }" @click="view = 'activity'">
                    Activity
                    <template x-if="(state.recentOperations || []).length > 0">
                        <span x-text="'(' + (state.recentOperations || []).length + ')'" style="margin-left: 2px; opacity: 0.6;"></span>
                    </template>
                </button>
            </div>
            <div class="stats">
                <span><span class="stat-value" x-text="state.topics.length"></span> topics</span>
                <span><span class="stat-value" x-text="state.queues.length"></span> queues</span>
                <span><span class="stat-value" x-text="state.subscriptions.length"></span> subs</span>
            </div>
        </div>
        <div class="topbar-controls">
            <span class="connection-status" :class="{ connected: connected }">
                <span class="status-dot"></span>
                <span x-text="connected ? 'Live' : 'Connecting...'"></span>
            </span>
        </div>
    </div>

    <!-- Resources view -->
    <div class="main" x-show="view === 'resources'">
        <!-- Graph panel -->
        <div class="graph-panel">
            <div class="graph-container" x-ref="graphContainer">
                <svg class="svg-overlay" x-ref="svgOverlay"></svg>

                <template x-if="state.topics.length === 0 && state.queues.length === 0">
                    <div class="detail-empty" style="min-height: 300px;">
                        No resources yet. Create queues and topics to see them here.
                    </div>
                </template>

                <div class="graph-columns" x-ref="graphColumns" x-show="state.topics.length > 0 || state.queues.length > 0">
                    <!-- Topics column -->
                    <div class="graph-column" x-show="state.topics.length > 0">
                        <div class="column-header">SNS Topics</div>
                        <template x-for="topic in state.topics" :key="topic.arn">
                            <div class="resource-card topic"
                                 :class="{ selected: selected?.arn === topic.arn }"
                                 :data-arn="topic.arn"
                                 @click="selectTopic(topic)">
                                <div class="card-name" x-text="topic.name"></div>
                                <div class="card-type">SNS Topic</div>
                                <div class="card-badges">
                                    <span class="badge subs-count"
                                          x-text="getTopicSubCount(topic) + ' sub' + (getTopicSubCount(topic) !== 1 ? 's' : '')"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Queues column -->
                    <div class="graph-column" x-show="state.queues.length > 0">
                        <div class="column-header">SQS Queues</div>
                        <template x-for="queue in state.queues" :key="queue.arn">
                            <div class="resource-card queue"
                                 :class="{ selected: selected?.arn === queue.arn, 'is-dlq': isDlqTarget(queue) }"
                                 :data-arn="queue.arn"
                                 @click="selectQueue(queue)">
                                <div class="card-name" x-text="queue.name"></div>
                                <div class="card-type" x-text="isDlqTarget(queue) ? 'Dead Letter Queue' : 'SQS Queue'"></div>
                                <div class="card-badges">
                                    <span class="badge available" x-text="queue.messagesAvailable + ' msgs'"></span>
                                    <template x-if="queue.messagesInFlight > 0">
                                        <span class="badge in-flight" x-text="queue.messagesInFlight + ' in-flight'"></span>
                                    </template>
                                    <template x-if="queue.isFifo">
                                        <span class="badge fifo">FIFO</span>
                                    </template>
                                    <template x-if="queue.hasDeadLetterQueue">
                                        <span class="badge dlq">DLQ</span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail panel -->
        <div class="detail-panel">
            <template x-if="!selected">
                <div class="detail-empty">
                    Select a resource to view details
                </div>
            </template>

            <template x-if="selected">
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <div class="detail-header">
                        <div class="detail-title" x-text="selected.name"></div>
                        <div class="detail-subtitle" x-text="selected.arn"></div>
                    </div>

                    <!-- Queue detail -->
                    <template x-if="selectedType === 'queue'">
                        <div style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
                            <div class="detail-tabs">
                                <button class="detail-tab" :class="{ active: detailTab === 'info' }" @click="detailTab = 'info'">Info</button>
                                <button class="detail-tab" :class="{ active: detailTab === 'messages' }" @click="detailTab = 'messages'; loadMessages()">
                                    Messages
                                    <span x-show="selected.messagesAvailable + selected.messagesInFlight > 0"
                                          x-text="'(' + (selected.messagesAvailable + selected.messagesInFlight) + ')'"
                                          style="margin-left: 2px;"></span>
                                </button>
                                <button class="detail-tab" :class="{ active: detailTab === 'subscriptions' }" @click="detailTab = 'subscriptions'">Subscriptions</button>
                            </div>
                            <div class="detail-body">
                                <!-- Info tab -->
                                <div x-show="detailTab === 'info'">
                                    <table class="props-table">
                                        <tr><td>URL</td><td x-text="selected.url"></td></tr>
                                        <tr><td>ARN</td><td x-text="selected.arn"></td></tr>
                                        <tr><td>Type</td><td x-text="selected.isFifo ? 'FIFO' : 'Standard'"></td></tr>
                                        <tr><td>Messages</td><td x-text="selected.messagesAvailable"></td></tr>
                                        <tr><td>In Flight</td><td x-text="selected.messagesInFlight"></td></tr>
                                        <tr><td>Visibility</td><td x-text="selected.visibilityTimeoutSeconds + 's'"></td></tr>
                                        <template x-if="selected.hasDeadLetterQueue">
                                            <tr><td>DLQ</td><td x-text="selected.deadLetterQueueName"></td></tr>
                                        </template>
                                        <template x-if="selected.maxReceiveCount">
                                            <tr><td>Max Receives</td><td x-text="selected.maxReceiveCount"></td></tr>
                                        </template>
                                    </table>
                                </div>

                                <!-- Messages tab -->
                                <div x-show="detailTab === 'messages'">
                                    <template x-if="messages === null">
                                        <div class="no-messages">Loading...</div>
                                    </template>
                                    <template x-if="messages !== null && messages.pendingMessages.length === 0 && messages.inFlightMessages.length === 0">
                                        <div class="no-messages">No messages in queue</div>
                                    </template>
                                    <template x-if="messages !== null">
                                        <div>
                                            <template x-for="msg in messages.pendingMessages" :key="msg.messageId">
                                                <div class="message-item" :class="{ expanded: expandedMsg === msg.messageId }" @click="toggleMsg(msg.messageId)">
                                                    <div class="message-header">
                                                        <span class="message-id" x-text="(msg.messageId || '').substring(0, 8) + '...'" :title="msg.messageId || ''"></span>
                                                        <span class="message-status pending">pending</span>
                                                    </div>
                                                    <div class="msg-preview" x-show="expandedMsg !== msg.messageId" x-text="msg.body.substring(0, 120) + (msg.body.length > 120 ? '...' : '')"></div>
                                                    <div x-show="expandedMsg === msg.messageId">
                                                        <div class="message-body-container">
                                                            <div class="message-body" x-text="formatBody(msg.body)"></div>
                                                            <button class="copy-btn" @click.stop="copyText(msg.body)">Copy</button>
                                                        </div>
                                                        <template x-if="msg.messageGroupId">
                                                            <div class="message-attrs">
                                                                <div class="message-attrs-title">Message Group</div>
                                                                <dd x-text="msg.messageGroupId"></dd>
                                                            </div>
                                                        </template>
                                                        <template x-if="msg.messageAttributes && Object.keys(msg.messageAttributes).length > 0">
                                                            <div class="message-attrs">
                                                                <div class="message-attrs-title">Message Attributes</div>
                                                                <template x-for="[key, val] in Object.entries(msg.messageAttributes)" :key="key">
                                                                    <div>
                                                                        <dt x-text="key"></dt>
                                                                        <dd x-text="val"></dd>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                        <template x-if="msg.attributes && Object.keys(msg.attributes).length > 0">
                                                            <div class="message-attrs">
                                                                <div class="message-attrs-title">System Attributes</div>
                                                                <template x-for="[key, val] in Object.entries(msg.attributes)" :key="key">
                                                                    <div>
                                                                        <dt x-text="key"></dt>
                                                                        <dd x-text="val"></dd>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                            <template x-for="msg in messages.inFlightMessages" :key="msg.messageId">
                                                <div class="message-item" :class="{ expanded: expandedMsg === msg.messageId }" @click="toggleMsg(msg.messageId)">
                                                    <div class="message-header">
                                                        <span class="message-id" x-text="(msg.messageId || '').substring(0, 8) + '...'" :title="msg.messageId || ''"></span>
                                                        <span class="message-status in-flight">in-flight</span>
                                                    </div>
                                                    <div class="msg-preview" x-show="expandedMsg !== msg.messageId" x-text="msg.body.substring(0, 120) + (msg.body.length > 120 ? '...' : '')"></div>
                                                    <div x-show="expandedMsg === msg.messageId">
                                                        <div class="message-body-container">
                                                            <div class="message-body" x-text="formatBody(msg.body)"></div>
                                                            <button class="copy-btn" @click.stop="copyText(msg.body)">Copy</button>
                                                        </div>
                                                        <template x-if="msg.messageAttributes && Object.keys(msg.messageAttributes).length > 0">
                                                            <div class="message-attrs">
                                                                <div class="message-attrs-title">Message Attributes</div>
                                                                <template x-for="[key, val] in Object.entries(msg.messageAttributes)" :key="key">
                                                                    <div>
                                                                        <dt x-text="key"></dt>
                                                                        <dd x-text="val"></dd>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                        <template x-if="msg.attributes && Object.keys(msg.attributes).length > 0">
                                                            <div class="message-attrs">
                                                                <div class="message-attrs-title">System Attributes</div>
                                                                <template x-for="[key, val] in Object.entries(msg.attributes)" :key="key">
                                                                    <div>
                                                                        <dt x-text="key"></dt>
                                                                        <dd x-text="val"></dd>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>

                                <!-- Subscriptions tab -->
                                <div x-show="detailTab === 'subscriptions'">
                                    <template x-if="getQueueSubscriptions(selected).length === 0">
                                        <div class="no-messages">No subscriptions to this queue</div>
                                    </template>
                                    <template x-for="sub in getQueueSubscriptions(selected)" :key="sub.subscriptionArn">
                                        <div class="sub-item">
                                            <div class="sub-item-target" x-text="getTopicNameFromArn(sub.topicArn)"></div>
                                            <div class="sub-item-detail">
                                                <span x-text="sub.raw ? 'Raw delivery' : 'SNS envelope'"></span>
                                                <template x-if="sub.filterPolicy">
                                                    <span> &middot; Filter: <span x-text="sub.filterPolicy"></span></span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Topic detail -->
                    <template x-if="selectedType === 'topic'">
                        <div style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
                            <div class="detail-tabs">
                                <button class="detail-tab" :class="{ active: detailTab === 'info' }" @click="detailTab = 'info'">Info</button>
                                <button class="detail-tab" :class="{ active: detailTab === 'subscriptions' }" @click="detailTab = 'subscriptions'">
                                    Subscriptions
                                    <span x-text="'(' + getTopicSubCount(selected) + ')'" style="margin-left: 2px;"></span>
                                </button>
                            </div>
                            <div class="detail-body">
                                <!-- Info tab -->
                                <div x-show="detailTab === 'info'">
                                    <table class="props-table">
                                        <tr><td>ARN</td><td x-text="selected.arn"></td></tr>
                                        <tr><td>Subscriptions</td><td x-text="getTopicSubCount(selected)"></td></tr>
                                    </table>
                                </div>

                                <!-- Subscriptions tab -->
                                <div x-show="detailTab === 'subscriptions'">
                                    <template x-if="getTopicSubscriptions(selected).length === 0">
                                        <div class="no-messages">No subscriptions from this topic</div>
                                    </template>
                                    <template x-for="sub in getTopicSubscriptions(selected)" :key="sub.subscriptionArn">
                                        <div class="sub-item">
                                            <div class="sub-item-target" x-text="getQueueNameFromEndpoint(sub.endpoint)"></div>
                                            <div class="sub-item-detail">
                                                <span x-text="sub.raw ? 'Raw delivery' : 'SNS envelope'"></span>
                                                <template x-if="sub.filterPolicy">
                                                    <span> &middot; Filter: <span x-text="sub.filterPolicy"></span></span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <!-- Activity view -->
    <div class="main" x-show="view === 'activity'">
        <div class="activity-panel">
            <div class="activity-toolbar">
                <div class="activity-toolbar-left">
                    <span class="activity-title">API Activity</span>
                    <span class="activity-count" x-text="filteredOperations().length + ' operations'"></span>
                </div>
                <div class="activity-filters">
                    <button class="filter-btn" :class="{ active: activityFilter === 'all' }" @click="activityFilter = 'all'">All</button>
                    <button class="filter-btn" :class="{ active: activityFilter === 'sqs' }" @click="activityFilter = 'sqs'">SQS</button>
                    <button class="filter-btn" :class="{ active: activityFilter === 'sns' }" @click="activityFilter = 'sns'">SNS</button>
                </div>
            </div>
            <div class="activity-list">
                <template x-if="filteredOperations().length === 0">
                    <div class="activity-empty">
                        <span x-text="(state.recentOperations || []).length === 0 ? 'No API operations recorded yet. Usage tracking is enabled.' : 'No operations match the current filter.'"></span>
                    </div>
                </template>
                <template x-if="filteredOperations().length > 0">
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th style="width: 90px;">Time</th>
                                <th style="width: 50px;">Service</th>
                                <th style="width: 180px;">Action</th>
                                <th>Resource</th>
                                <th style="width: 30px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(op, idx) in filteredOperations()" :key="idx">
                                <tr>
                                    <td><span class="activity-time" x-text="formatTime(op.timestamp)"></span></td>
                                    <td><span class="activity-service" :class="op.service" x-text="op.service.toUpperCase()"></span></td>
                                    <td><span class="activity-action" x-text="op.action"></span></td>
                                    <td><span class="activity-resource" x-text="simplifyArn(op.resourceArn)" :title="op.resourceArn"></span></td>
                                    <td><span class="activity-result" :class="op.success ? 'success' : 'failure'" x-text="op.success ? '\u2713' : '\u2717'"></span></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </template>
            </div>
        </div>
    </div>

</body>
</html>
