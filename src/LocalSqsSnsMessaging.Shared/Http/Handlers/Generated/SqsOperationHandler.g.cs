// <auto-generated/>
// Generated JSON protocol handler for Sqs (HttpRequestMessage variant - library only)
#if !ASPNETCORE

using System.Buffers;
using System.Net;
using System.Text;
using LocalSqsSnsMessaging.Sqs.Model;
using LocalSqsSnsMessaging.Http;

namespace LocalSqsSnsMessaging.Http.Handlers;

internal static partial class SqsOperationHandler
{
    public static async Task<HttpResponseMessage> HandleAsync(
        HttpRequestMessage request,
        string operationName,
        InMemoryAwsBus bus,
        CancellationToken cancellationToken)
    {
        ArgumentNullException.ThrowIfNull(request);
        ArgumentNullException.ThrowIfNull(operationName);
        ArgumentNullException.ThrowIfNull(bus);

        var client = new InternalSqsClient(bus);

        return operationName switch
        {
            "AddPermission" => await HandleAddPermissionAsync(request, client, cancellationToken),
            "CancelMessageMoveTask" => await HandleCancelMessageMoveTaskAsync(request, client, cancellationToken),
            "ChangeMessageVisibility" => await HandleChangeMessageVisibilityAsync(request, client, cancellationToken),
            "ChangeMessageVisibilityBatch" => await HandleChangeMessageVisibilityBatchAsync(request, client, cancellationToken),
            "CreateQueue" => await HandleCreateQueueAsync(request, client, cancellationToken),
            "DeleteMessage" => await HandleDeleteMessageAsync(request, client, cancellationToken),
            "DeleteMessageBatch" => await HandleDeleteMessageBatchAsync(request, client, cancellationToken),
            "DeleteQueue" => await HandleDeleteQueueAsync(request, client, cancellationToken),
            "GetQueueAttributes" => await HandleGetQueueAttributesAsync(request, client, cancellationToken),
            "GetQueueUrl" => await HandleGetQueueUrlAsync(request, client, cancellationToken),
            "ListDeadLetterSourceQueues" => await HandleListDeadLetterSourceQueuesAsync(request, client, cancellationToken),
            "ListMessageMoveTasks" => await HandleListMessageMoveTasksAsync(request, client, cancellationToken),
            "ListQueueTags" => await HandleListQueueTagsAsync(request, client, cancellationToken),
            "ListQueues" => await HandleListQueuesAsync(request, client, cancellationToken),
            "PurgeQueue" => await HandlePurgeQueueAsync(request, client, cancellationToken),
            "ReceiveMessage" => await HandleReceiveMessageAsync(request, client, cancellationToken),
            "RemovePermission" => await HandleRemovePermissionAsync(request, client, cancellationToken),
            "SendMessage" => await HandleSendMessageAsync(request, client, cancellationToken),
            "SendMessageBatch" => await HandleSendMessageBatchAsync(request, client, cancellationToken),
            "SetQueueAttributes" => await HandleSetQueueAttributesAsync(request, client, cancellationToken),
            "StartMessageMoveTask" => await HandleStartMessageMoveTaskAsync(request, client, cancellationToken),
            "TagQueue" => await HandleTagQueueAsync(request, client, cancellationToken),
            "UntagQueue" => await HandleUntagQueueAsync(request, client, cancellationToken),
            _ => throw new NotSupportedException($"Sqs operation '{operationName}' is not supported.")
        };
    }

    private static async Task<HttpResponseMessage> HandleAddPermissionAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeAddPermissionRequest(requestStream);
            var result = await client.AddPermissionAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeAddPermissionResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleCancelMessageMoveTaskAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeCancelMessageMoveTaskRequest(requestStream);
            var result = await client.CancelMessageMoveTaskAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeCancelMessageMoveTaskResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleChangeMessageVisibilityAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeChangeMessageVisibilityRequest(requestStream);
            var result = await client.ChangeMessageVisibilityAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeChangeMessageVisibilityResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleChangeMessageVisibilityBatchAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeChangeMessageVisibilityBatchRequest(requestStream);
            var result = await client.ChangeMessageVisibilityBatchAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeChangeMessageVisibilityBatchResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleCreateQueueAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeCreateQueueRequest(requestStream);
            var result = await client.CreateQueueAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeCreateQueueResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleDeleteMessageAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeDeleteMessageRequest(requestStream);
            var result = await client.DeleteMessageAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeDeleteMessageResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleDeleteMessageBatchAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeDeleteMessageBatchRequest(requestStream);
            var result = await client.DeleteMessageBatchAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeDeleteMessageBatchResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleDeleteQueueAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeDeleteQueueRequest(requestStream);
            var result = await client.DeleteQueueAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeDeleteQueueResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleGetQueueAttributesAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeGetQueueAttributesRequest(requestStream);
            var result = await client.GetQueueAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeGetQueueAttributesResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleGetQueueUrlAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeGetQueueUrlRequest(requestStream);
            var result = await client.GetQueueUrlAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeGetQueueUrlResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListDeadLetterSourceQueuesAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeListDeadLetterSourceQueuesRequest(requestStream);
            var result = await client.ListDeadLetterSourceQueuesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeListDeadLetterSourceQueuesResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListMessageMoveTasksAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeListMessageMoveTasksRequest(requestStream);
            var result = await client.ListMessageMoveTasksAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeListMessageMoveTasksResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListQueueTagsAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeListQueueTagsRequest(requestStream);
            var result = await client.ListQueueTagsAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeListQueueTagsResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleListQueuesAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeListQueuesRequest(requestStream);
            var result = await client.ListQueuesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeListQueuesResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandlePurgeQueueAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializePurgeQueueRequest(requestStream);
            var result = await client.PurgeQueueAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializePurgeQueueResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleReceiveMessageAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeReceiveMessageRequest(requestStream);
            var result = await client.ReceiveMessageAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeReceiveMessageResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleRemovePermissionAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeRemovePermissionRequest(requestStream);
            var result = await client.RemovePermissionAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeRemovePermissionResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleSendMessageAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeSendMessageRequest(requestStream);
            var result = await client.SendMessageAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeSendMessageResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleSendMessageBatchAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeSendMessageBatchRequest(requestStream);
            var result = await client.SendMessageBatchAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeSendMessageBatchResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleSetQueueAttributesAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeSetQueueAttributesRequest(requestStream);
            var result = await client.SetQueueAttributesAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeSetQueueAttributesResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleStartMessageMoveTaskAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeStartMessageMoveTaskRequest(requestStream);
            var result = await client.StartMessageMoveTaskAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeStartMessageMoveTaskResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleTagQueueAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeTagQueueRequest(requestStream);
            var result = await client.TagQueueAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeTagQueueResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static async Task<HttpResponseMessage> HandleUntagQueueAsync(
        HttpRequestMessage request,
        InternalSqsClient client,
        CancellationToken cancellationToken)
    {
        try
        {
            using var requestStream = await request.Content!.ReadAsStreamAsync().ConfigureAwait(false);
            var requestObject = SqsJsonSerializers.DeserializeUntagQueueRequest(requestStream);
            var result = await client.UntagQueueAsync(requestObject, cancellationToken).ConfigureAwait(false);

            using var pooledBuffer = PooledArrayBufferWriter.Rent();
            SqsJsonSerializers.SerializeUntagQueueResponse(result, pooledBuffer.Writer);

            var response = new HttpResponseMessage(HttpStatusCode.OK)
            {
                Content = new ByteArrayContent(pooledBuffer.Writer.WrittenSpan.ToArray())
            };
            response.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/x-amz-json-1.0");
            return response;
        }
        catch (OperationCanceledException)
        {
            throw;
        }
        catch (AwsServiceException ex)
        {
            return CreateErrorResponse(ex);
        }
    }

    private static HttpResponseMessage CreateErrorResponse(Exception exception)
    {
        string errorCode;
        string errorMessage;
        HttpStatusCode statusCode;

        if (exception is AwsServiceException awsException)
        {
            errorCode = awsException.ErrorCode ?? exception.GetType().Name.Replace("Exception", "");
            errorMessage = awsException.Message;
            statusCode = awsException.StatusCode;
        }
        else
        {
            errorCode = exception.GetType().Name.Replace("Exception", "");
            errorMessage = exception.Message;
            statusCode = HttpStatusCode.InternalServerError;
        }

        var errorType = $"com.amazonaws.sqs#{errorCode}";

        var errorJson = $$"""
        {
            "__type": "{{errorType}}",
            "message": "{{errorMessage.Replace("\"", "\\\"", StringComparison.Ordinal)}}"
        }
        """;

        return new HttpResponseMessage(statusCode)
        {
            Content = new StringContent(errorJson, Encoding.UTF8, "application/x-amz-json-1.0")
        };
    }
}

#endif
